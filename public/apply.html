<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Brain-O-Math Olympiad 2025 - Registration</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  --danger-gradient: linear-gradient(135deg, #ff416c 0%, #ff4757 100%);
  --background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  --card-shadow: 0 20px 40px rgba(0,0,0,0.1);
  --card-shadow-hover: 0 25px 50px rgba(0,0,0,0.15);
  --text-primary: #2d3748;
  --text-secondary: #4a5568;
  --border-color: #e2e8f0;
  --border-radius: 16px;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--background);
  min-height: 100vh;
  line-height: 1.6;
  color: var(--text-primary);
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: 
    radial-gradient(circle at 20% 20%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.1) 0%, transparent 50%);
  pointer-events: none;
  z-index: -1;
}

.container {
  max-width: 900px;
  margin: 40px auto;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  border-radius: var(--border-radius);
  box-shadow: var(--card-shadow);
  padding: 40px;
  position: relative;
  overflow: hidden;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 4px;
  background: var(--primary-gradient);
}

h2 {
  background: var(--primary-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-align: center;
  font-size: 2.5rem;
  font-weight: 700;
  margin-bottom: 40px;
  position: relative;
}

h2::after {
  content: '';
  position: absolute;
  bottom: -10px;
  left: 50%;
  transform: translateX(-50%);
  width: 80px;
  height: 3px;
  background: var(--primary-gradient);
  border-radius: 2px;
}

h3 {
  color: var(--text-primary);
  font-size: 1.5rem;
  font-weight: 600;
  margin-bottom: 24px;
  display: flex;
  align-items: center;
  gap: 12px;
}

h3::before {
  content: '';
  width: 6px;
  height: 24px;
  background: var(--primary-gradient);
  border-radius: 3px;
}

.registration-form {
  margin: 32px 0;
  opacity: 0;
  transform: translateY(20px);
  animation: fadeInUp 0.6s ease-out forwards;
}

@keyframes fadeInUp {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 24px;
  margin-bottom: 32px;
}

.form-group {
  position: relative;
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  font-weight: 500;
  color: var(--text-secondary);
  margin-bottom: 8px;
  font-size: 0.9rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

input, select {
  width: 100%;
  padding: 16px 20px;
  border: 2px solid var(--border-color);
  border-radius: 12px;
  font-size: 1rem;
  font-family: inherit;
  transition: var(--transition);
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(10px);
}

input:focus, select:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
  transform: translateY(-2px);
}

input:hover, select:hover {
  border-color: #667eea;
}

.file-upload {
  position: relative;
  display: inline-block;
  width: 100%;
}

.file-upload input[type=file] {
  position: absolute;
  left: -9999px;
  opacity: 0;
}

.file-upload-label {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  padding: 16px 20px;
  border: 2px dashed var(--border-color);
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.8);
  cursor: pointer;
  transition: var(--transition);
  text-align: center;
  min-height: 80px;
}

.file-upload-label:hover {
  border-color: #667eea;
  background: rgba(102, 126, 234, 0.05);
}

.file-upload-label.has-file {
  border-color: #10b981;
  background: rgba(16, 185, 129, 0.05);
}

.cta-button, .btn-secondary {
  padding: 16px 32px;
  border-radius: 12px;
  border: none;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin: 8px 8px 0 0;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  text-decoration: none;
}

.cta-button {
  background: var(--primary-gradient);
  color: white;
  box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
}

.cta-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
}

.cta-button:active {
  transform: translateY(0);
}

.cta-button:disabled {
  background: linear-gradient(135deg, #cbd5e0 0%, #a0aec0 100%);
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.btn-secondary {
  background: rgba(255, 255, 255, 0.9);
  color: var(--text-primary);
  border: 2px solid var(--border-color);
  backdrop-filter: blur(10px);
}

.btn-secondary:hover {
  background: rgba(255, 255, 255, 1);
  border-color: #667eea;
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
}

.upi-button {
  background: linear-gradient(135deg, #ff6b35 0%, #ff8500 100%);
  color: white;
  padding: 20px 32px;
  border-radius: 12px;
  border: none;
  font-weight: 600;
  font-size: 1.1rem;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  text-decoration: none;
  margin-bottom: 20px;
  box-shadow: 0 8px 20px rgba(255, 107, 53, 0.3);
}

.upi-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 30px rgba(255, 107, 53, 0.4);
}

.student-card {
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 16px;
  position: relative;
  transition: var(--transition);
  animation: slideIn 0.4s ease-out;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.student-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
}

.student-card h4 {
  color: var(--text-primary);
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 8px;
}

.student-card p {
  color: var(--text-secondary);
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

.student-card .remove-btn {
  position: absolute;
  top: 16px;
  right: 16px;
  background: var(--danger-gradient);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 6px 12px;
  cursor: pointer;
  font-size: 0.8rem;
  font-weight: 500;
  transition: var(--transition);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.remove-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(255, 65, 108, 0.3);
}

.fee-summary {
  background: linear-gradient(135deg, rgba(74, 222, 128, 0.1) 0%, rgba(34, 197, 94, 0.1) 100%);
  border: 1px solid rgba(34, 197, 94, 0.2);
  border-radius: 12px;
  padding: 24px;
  margin: 24px 0;
  backdrop-filter: blur(10px);
}

.fee-summary h3 {
  color: #059669;
  margin-bottom: 16px;
  font-size: 1.2rem;
}

.fee-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid rgba(34, 197, 94, 0.1);
}

.fee-item:last-child {
  border-bottom: none;
}

.total-fee {
  font-size: 1.2rem;
  font-weight: 700;
  color: #059669;
  text-align: right;
  margin-top: 16px;
  padding-top: 16px;
  border-top: 2px solid rgba(34, 197, 94, 0.2);
}

.payment-instructions {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.1) 100%);
  border: 1px solid rgba(59, 130, 246, 0.2);
  border-radius: 12px;
  padding: 24px;
  margin: 24px 0;
  backdrop-filter: blur(10px);
}

.payment-instructions h4 {
  color: #2563eb;
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.payment-instructions ol {
  margin-left: 20px;
  color: var(--text-secondary);
}

.payment-instructions li {
  margin-bottom: 8px;
}

.success-message {
  background: linear-gradient(135deg, rgba(74, 222, 128, 0.1) 0%, rgba(34, 197, 94, 0.1) 100%);
  border: 1px solid rgba(34, 197, 94, 0.2);
  padding: 40px;
  border-radius: 16px;
  text-align: center;
  margin-top: 32px;
  backdrop-filter: blur(10px);
  animation: celebrationBounce 0.8s ease-out;
}

@keyframes celebrationBounce {
  0%, 20%, 50%, 80%, 100% {
    transform: translateY(0);
  }
  40% {
    transform: translateY(-10px);
  }
  60% {
    transform: translateY(-5px);
  }
}

.success-message h4 {
  color: #059669;
  font-size: 1.8rem;
  margin-bottom: 16px;
  font-weight: 700;
}

.success-message p {
  color: var(--text-secondary);
  font-size: 1.1rem;
  margin-bottom: 8px;
}

.success-message strong {
  color: var(--text-primary);
}

/* Step indicator */
.step-indicator {
  display: flex;
  justify-content: center;
  margin-bottom: 40px;
  gap: 20px;
}

.step {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  color: white;
  position: relative;
  transition: var(--transition);
}

.step.active {
  background: var(--primary-gradient);
  box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
}

.step.completed {
  background: var(--success-gradient);
}

.step.inactive {
  background: #cbd5e0;
}

.step::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 100%;
  transform: translateY(-50%);
  width: 20px;
  height: 2px;
  background: #cbd5e0;
  z-index: -1;
}

.step:last-child::after {
  display: none;
}

/* Loading animation */
.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s ease-in-out infinite;
  margin-left: 8px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Responsive design */
@media (max-width: 768px) {
  .container {
    margin: 20px;
    padding: 24px;
  }
  
  h2 {
    font-size: 2rem;
  }
  
  .form-grid {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  .cta-button, .btn-secondary {
    width: 100%;
    margin: 8px 0;
  }
  
  .student-card p {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
  }
  
  .remove-btn {
    position: static;
    margin-top: 12px;
    align-self: flex-start;
  }
}

/* Micro-interactions */
.form-group input:valid {
  border-color: #10b981;
}

.form-group input:invalid:not(:placeholder-shown) {
  border-color: #ef4444;
}

.pulse {
  animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: .5;
  }
}
</style>
</head>
<body>
<section id="registration" class="section">
  <div class="container">
    <h2><i class="fas fa-brain"></i> Brain-O-Math Olympiad 2025</h2>
    
    <!-- Step Indicator -->
    <div class="step-indicator">
      <div class="step active" id="step1">1</div>
      <div class="step inactive" id="step2">2</div>
      <div class="step inactive" id="step3">3</div>
      <div class="step inactive" id="step4">✓</div>
    </div>
    
    <!-- Step 1: School Info -->
    <div id="schoolForm" class="registration-form">
      <h3><i class="fas fa-school"></i> School Information</h3>
      <form id="schoolRegistrationForm" onsubmit="event.preventDefault(); nextStep(2);">
        <div class="form-grid">
          <div class="form-group">
            <label for="schoolName"><i class="fas fa-building"></i> School Name *</label>
            <input id="schoolName" required placeholder="Enter school name">
          </div>
          <div class="form-group">
            <label for="schoolAddress"><i class="fas fa-map-marker-alt"></i> School Address *</label>
            <input id="schoolAddress" required placeholder="Enter school address">
          </div>
          <div class="form-group">
            <label for="coordinatorName"><i class="fas fa-user-tie"></i> Coordinator Name *</label>
            <input id="coordinatorName" required placeholder="Enter coordinator name">
          </div>
          <div class="form-group">
            <label for="coordinatorEmail"><i class="fas fa-envelope"></i> Coordinator Email *</label>
            <input id="coordinatorEmail" type="email" required placeholder="Enter email address">
          </div>
          <div class="form-group">
            <label for="coordinatorPhone"><i class="fas fa-phone"></i> Coordinator Phone *</label>
            <input id="coordinatorPhone" type="tel" pattern="[0-9]{10}" required placeholder="Enter 10-digit phone number">
          </div>
        </div>
        <button type="submit" class="cta-button">
          <i class="fas fa-arrow-right"></i> Next: Add Students
        </button>
      </form>
    </div>
    
    <!-- Step 2: Student Info -->
    <div id="studentForm" class="registration-form" style="display:none">
      <h3><i class="fas fa-user-graduate"></i> Student Information</h3>
      <div class="form-grid">
        <div class="form-group">
          <label for="studentName"><i class="fas fa-user"></i> Student Name *</label>
          <input id="studentName" placeholder="Enter student name">
        </div>
        <div class="form-group">
          <label for="studentClass"><i class="fas fa-graduation-cap"></i> Class *</label>
          <select id="studentClass">
            <option value="">Select Class</option>
            <option>3</option><option>4</option><option>5</option>
            <option>6</option><option>7</option><option>8</option>
            <option>9</option><option>10</option><option>11</option><option>12</option>
          </select>
        </div>
        <div class="form-group">
          <label for="studentCategory"><i class="fas fa-tag"></i> Category</label>
          <input id="studentCategory" readonly placeholder="Auto-filled based on class">
        </div>
        <div class="form-group">
          <label for="subjects"><i class="fas fa-book"></i> Subjects *</label>
          <select id="subjects">
            <option value="">Select Subject</option>
            <option value="math">Mathematics (₹70)</option>
            <option value="science">Science (₹70)</option>
            <option value="both">Both (₹140)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="parentName"><i class="fas fa-users"></i> Parent's Name (optional)</label>
          <input id="parentName" placeholder="Enter parent's name">
        </div>
        <div class="form-group">
          <label for="parentContact"><i class="fas fa-mobile-alt"></i> Parent's Contact (optional)</label>
          <input id="parentContact" pattern="[0-9]{10}" placeholder="Enter 10-digit contact number">
        </div>
      </div>
      
      <button type="button" class="btn-secondary" style="background: #10b981;" onclick="addStudent()">
        <i class="fas fa-plus"></i> Save Student Detials
      </button>
       <button type="button" class="btn-secondary" style="background: #10b981;" onclick="addStudent()">
        <i class="fas fa-plus"></i> Add More Student
      </button>

      <button type="button" class="btn-secondary" onclick="previousStep(1)">
        <i class="fas fa-arrow-left"></i> Previous
      </button>
      <button id="proceedToPayment" type="button" class="cta-button" onclick="nextStep(3)" disabled>
        <i class="fas fa-credit-card"></i> Proceed to Payment
      </button>
      <div id="studentsContainer"></div>
    </div>
    
    <!-- Step 3: Payment -->
    <div id="paymentForm" class="registration-form" style="display:none">
      <h3><i class="fas fa-credit-card"></i> UPI Payment</h3>
      <div class="fee-summary">
        <h3><i class="fas fa-calculator"></i> Fee Summary</h3>
        <div id="feeBreakdown"></div>
        <div class="total-fee">Total Amount: ₹<span id="totalAmount">0</span></div>
      </div>
      
      <div class="payment-instructions">
        <h4><i class="fas fa-mobile-alt"></i> Payment Instructions</h4>
        <ol>
          <li>Click the "Pay via UPI" button below to open your UPI app</li>
          <li>Complete the payment using any UPI app (GPay, PhonePe, Paytm, etc.)</li>
          <li>Take a screenshot of the successful payment confirmation</li>
          <li>Upload the screenshot below and submit your registration</li>
        </ol>
      </div>
      
      <a id="upiPaymentLink" class="upi-button" target="_blank">
        <i class="fas fa-mobile-alt"></i> Pay ₹<span id="upiAmount">0</span> via UPI
      </a>
      <h2>OR</h2>
      <h2>Scan This QR To Payment</h2>
      <div style="text-align: center; margin: 20px 0;">
        <img src="scanner.jpg" alt="Scan UPI" style="max-width: 300px; width: 100%; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.1);">
      </div>
      
      <div class="form-group">
        <label for="paymentScreenshot"><i class="fas fa-camera"></i> Upload Payment Screenshot *</label>
        <div class="file-upload">
          <input type="file" id="paymentScreenshot" accept="image/*" required>
          <label for="paymentScreenshot" class="file-upload-label" id="fileUploadLabel">
            <i class="fas fa-cloud-upload-alt"></i>
            <span>Click to upload screenshot or drag & drop</span>
          </label>
        </div>
      </div>
      
      <button id="submitRegistration" class="cta-button" disabled>
        <i class="fas fa-check"></i> Submit Registration
      </button>
      <button type="button" class="btn-secondary" onclick="previousStep(2)">
        <i class="fas fa-arrow-left"></i> Previous
      </button>
    </div>
    
    <!-- Step 4: Success -->
    <div id="successMessage" class="success-message" style="display:none">
      <h4><i class="fas fa-check-circle"></i> Registration Successful!</h4>
      <p><strong>Registration ID:</strong> <span id="registrationId"></span></p>
      <p><i class="fas fa-check"></i> Status: Payment Screenshot Uploaded</p>
      <p><i class="fas fa-info-circle"></i> Your registration will be verified within 24 hours</p>
      <button onclick="resetAll()" class="cta-button">
        <i class="fas fa-plus"></i> New Registration
      </button>
    </div>
  </div>
</section>

<script>
// --- JS STATE ---
let regData = { school:{}, students:[], amount:0, paymentScreenshot: null };
let step = 1;
const UPI_ID = 'krishnendupatra57@okicici';
const PAYEE_NAME = 'Brain-O-Math Olympiad';

// --- CATEGORY MAP ---
function getCategory(cls) {
  let c = parseInt(cls,10);
  if (c>=3 && c<=4)  return 'A';
  if (c>=5 && c<=6)  return 'B';
  if (c>=7 && c<=8)  return 'C';
  if (c>=9 && c<=10) return 'D';
  if (c>=11)         return 'E';
  return '-';
}

// --- STEP INDICATOR UPDATE ---
function updateStepIndicator(currentStep) {
  for (let i = 1; i <= 4; i++) {
    const stepEl = document.getElementById(`step${i}`);
    if (i < currentStep) {
      stepEl.className = 'step completed';
    } else if (i === currentStep) {
      stepEl.className = 'step active';
    } else {
      stepEl.className = 'step inactive';
    }
  }
}

// --- FORM STEP CONTROL ---
function showStep(n) {
  document.getElementById('schoolForm').style.display = n===1?'block':'none';
  document.getElementById('studentForm').style.display = n===2?'block':'none';
  document.getElementById('paymentForm').style.display = n===3?'block':'none';
  document.getElementById('successMessage').style.display = n===4?'block':'none';
  updateStepIndicator(n);
}

function nextStep(n) {
  if (n===2) {
    // collect school info
    regData.school = {
      schoolName: schoolName.value.trim(),
      schoolAddress: schoolAddress.value.trim(),
      coordinatorName: coordinatorName.value.trim(),
      coordinatorEmail: coordinatorEmail.value.trim(),
      coordinatorPhone: coordinatorPhone.value.trim()
    };
  }
  if (n===3) {
    calculateFees();
    setupUPIPayment();
  }
  showStep(step=n);
}

function previousStep(n) { showStep(step=n); }

// --- STUDENT ADD ---
function addStudent() {
  const name = studentName.value.trim();
  const cls = studentClass.value;
  const subj = subjects.value;
  if(!name || !cls || !subj){ 
    showAlert('Please fill all mandatory fields');
    return; 
  }
  const fee = subj==='both'?140:70;
  const st = {
        name,
        class: cls,                    // ✅ use `class`
        category: getCategory(cls),    // optional, backend can calculate
        subjects: subj,                // ✅ use `subjects`
        fee,
        parentContact: parentContact.value.trim() // ✅ match schema
    };

  regData.students.push(st);
  displayStudent(st);
  clearStudentForm();
  document.getElementById('proceedToPayment').disabled = false;
}

function displayStudent(s) {
  studentsContainer.insertAdjacentHTML('beforeend', `
    <div class="student-card" id="st${regData.students.length}">
      <button class="remove-btn" onclick="delStudent(${regData.students.length})">
        <i class="fas fa-trash"></i> Remove
      </button>
      <h4><i class="fas fa-user"></i> ${s.name}</h4>
      <p>
        <span><i class="fas fa-graduation-cap"></i> Class ${s.class}</span>
        <span><i class="fas fa-tag"></i> Category ${s.category}</span>
        <span><i class="fas fa-book"></i> ${subjText(s.subjects)}</span>
        <span><i class="fas fa-rupee-sign"></i> ₹${s.fee}</span>
      </p>
    </div>`);
}

function delStudent(id) {
  regData.students = regData.students.filter(x=>x.id!==id);
  document.getElementById('st'+id).remove();
  if(!regData.students.length) document.getElementById('proceedToPayment').disabled = true;
}
function subjText(v) {
  return v === 'both' ? 'Math & Science' : v === 'math' ? 'Mathematics' : 'Science';
}

//function subjText(v){return v==='both'?'Math & Science':v==='math'?'Mathematics':'Science';}

function clearStudentForm(){ 
  studentName.value=''; 
  studentClass.value=''; 
  subjects.value=''; 
  studentCategory.value=''; 
  parentName.value=''; 
  parentContact.value=''; 
}

studentClass.onchange = ()=> studentCategory.value = getCategory(studentClass.value);

// --- FEES ---
function calculateFees() {
  regData.totalAmount = regData.students.reduce((t,s)=>t+s.fee,0);
  document.getElementById('totalAmount').innerText = regData.totalAmount;
  document.getElementById('upiAmount').innerText = regData.totalAmount;
  document.getElementById('feeBreakdown').innerHTML = regData.students.map(s=>
    `<div class="fee-item">
      <span><i class="fas fa-user"></i> ${s.name} (${subjText(s.subj)})</span>
      <span><i class="fas fa-rupee-sign"></i> ₹${s.fee}</span>
    </div>`).join('');
}

// --- UPI PAYMENT SETUP ---
function setupUPIPayment() {
  const amount = regData.amount;
  const transactionNote = `Brain-O-Math Olympiad 2025 Registration - ${regData.school.schoolName}`;

  const upiLink = `upi://pay?pa=${UPI_ID}&pn=${encodeURIComponent(PAYEE_NAME)}&am=${amount}&cu=INR&tn=${encodeURIComponent(transactionNote)}`;

  const intentLink = `intent://${upiLink.replace('upi://', '')}#Intent;scheme=upi;package=com.google.android.apps.nbu.paisa.user;end`;

  // Try opening in UPI app via intent link
  const anchor = document.getElementById('upiPaymentLink');
  anchor.href = intentLink;

  // Fallback: open regular UPI URI on click (mobile only)
  anchor.onclick = function(e) {
    if (/Android/i.test(navigator.userAgent)) {
      window.location.href = intentLink;
    } else {
      alert('UPI apps can only be triggered from mobile devices.');
    }
  };
}

// --- FILE UPLOAD HANDLING ---
document.getElementById('paymentScreenshot').addEventListener('change', function(e) {
  const file = e.target.files[0];
  const label = document.getElementById('fileUploadLabel');
  
  if (file) {
    regData.paymentScreenshot = file;
    label.classList.add('has-file');
    label.innerHTML = `
      <i class="fas fa-check-circle"></i>
      <span>${file.name} (${(file.size/1024/1024).toFixed(2)} MB)</span>
    `;
    document.getElementById('submitRegistration').disabled = false;
  } else {
    regData.paymentScreenshot = null;
    label.classList.remove('has-file');
    label.innerHTML = `
      <i class="fas fa-cloud-upload-alt"></i>
      <span>Click to upload screenshot or drag & drop</span>
    `;
    document.getElementById('submitRegistration').disabled = true;
  }
});

// --- REGISTRATION SUBMISSION ---
document.getElementById('submitRegistration').onclick = async function() {
  if (!regData.paymentScreenshot) {
    showAlert('Please upload payment screenshot first');
    return;
  }

  const btn = this;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
  btn.disabled = true;

  // Prepare form data for file upload
  const formData = new FormData();
  formData.append('school', JSON.stringify(regData.school));
  formData.append('students', JSON.stringify(regData.students));
  formData.append('totalAmount', regData.totalAmount);
  formData.append('paymentScreenshot', regData.paymentScreenshot);

  try {
    const res = await fetch('/api/registrations', {
      method: 'POST',
      body: formData
    });
    const data = await res.json();
    if (res.ok && data.success) {
      document.getElementById('registrationId').innerText = data.data.registrationId;
      showStep(4);
    } else {
      showAlert(data.message || 'Registration failed');
    }
  } catch (err) {
    showAlert('Failed to submit registration. Please try again.');
  }

  btn.innerHTML = '<i class="fas fa-check"></i> Submit Registration';
  btn.disabled = false;
};


// --- RESET ---
function resetAll() {
  regData = { school:{}, students:[], amount:0, paymentScreenshot: null };
  step = 1;
  studentsContainer.innerHTML = '';
  document.getElementById('proceedToPayment').disabled = true;
  document.getElementById('submitRegistration').disabled = true;
  document.getElementById('schoolRegistrationForm').reset();
  document.getElementById('paymentScreenshot').value = '';
  document.getElementById('fileUploadLabel').classList.remove('has-file');
  document.getElementById('fileUploadLabel').innerHTML = `
    <i class="fas fa-cloud-upload-alt"></i>
    <span>Click to upload screenshot or drag & drop</span>
  `;
  showStep(1);
}

// --- CUSTOM ALERT FUNCTION ---
function showAlert(message) {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
  modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
  modal.innerHTML = `
    <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); max-width: 400px; width: 90%; text-align: center;">
      <div style="color: #ef4444; font-size: 48px; margin-bottom: 16px;">
        <i class="fas fa-exclamation-circle"></i>
      </div>
      <p style="color: #374151; font-size: 16px; margin-bottom: 24px;">${message}</p>
      <button onclick="this.closest('div').remove()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer;">
        OK
      </button>
    </div>
  `;
  document.body.appendChild(modal);
  
  // Auto remove after 5 seconds
  setTimeout(() => {
    if (modal.parentNode) {
      modal.remove();
    }
  }, 5000);
}

// Initialize
updateStepIndicator(1);
</script>
</body>
</html>